<!DOCTYPE html>
<html>

<head>
    <title>Create and Modify Excel File</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://stuk.github.io/jszip/dist/jszip.min.js"></script>
    <script src="../js/CreateExcel.js"></script>
    <style>
        img {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
        }
    </style>
</head>

<body>
    <table id="my-table" border="1" style="visibility: hidden;"></table>
    <hr>
    <button id="attachment-evidencefile-btn">エビデンスファイル添付</button>
    <button onclick="createAndModifyExcel()">テーブルの内容をExcel化</button>
    <p>
        TODO: <button id="excel-dl">テンプレートエクセルDL</button>
    </p>
    <script>
        // エビデンス添付テーブル
        let myTable = $('#my-table');
        // let myTableBody = null;
        let myTableBody = $('#my-table tbody');
        // エビデンスファイル格納配列
        let evidenceFiles = [];
        // Excelファイル作成処理
        let workbook = null;
        createExcel().then(loadExcel);
        function loadExcel(blob) {
            const reader = new FileReader();
            reader.onload = onLoadReader;
            reader.readAsArrayBuffer(blob);
        }

        async function onLoadReader(e) {
            workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(e.target.result);
        }

        // エビデンスファイル添付処理
        $('#attachment-evidencefile-btn').on('click', async (event) => {
            const btn = $(event.currentTarget);
            btn.prop('disabled', true);
            try {
                const directoryHandle = await window.showDirectoryPicker();
                myTable.css('visibility', 'visible');
                myTable.append($('<tbody>'));
                myTableBody = $('#my-table tbody');

                const structure = await readDirectory(directoryHandle);
                createMyTable(structure);
            } catch (error) {
                console.log('Error opening directory:', error);
            } finally {
                btn.prop('disabled', false);
            }
        });

        async function readDirectory(directoryHandle, path = '') {
            // 選択したディレクトリ内のフォルダ/ファイルをソート
            const entries = [];
            for await (const [name, handle] of directoryHandle.entries()) {
                if (name.startsWith('.')) {
                    // 先頭が「.」で始まるファイルは飛ばす
                    continue;
                }
                entries.push([name, handle]);
            }

            // フォルダ/ファイル名で昇順ソート
            entries.sort((a, b) => a[0].localeCompare(b[0]));

            const directoryStructure = [];
            for (const [name, handle] of entries) {
                // console.log({ name }, { handle });
                if (handle.kind === 'file') {
                    // console.log("file処理");
                    const file = await handle.getFile();
                    imgBase64 = await fileToBase64(file);
                    directoryStructure.push({
                        name: name,
                        type: 'file',
                        img_base64: imgBase64
                    });
                    continue;
                }

                if (handle.kind === 'directory') {
                    // console.log("directory処理");
                    const subDirectoryStructure = await readDirectory(handle, `${path}${name}/`);
                    directoryStructure.push({
                        name: name,
                        type: 'directory',
                        children: subDirectoryStructure
                    });
                    continue;
                }
            }
            return directoryStructure;
        }

        // 画像ファイルをbase64に変換
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function createMyTable(structure) {
            structure.forEach(element => {
                // シートの繰り返し
                if (element.children) {
                    element.children.forEach(element1 => {
                        // 各試験項目の繰り返し
                        if (element1.children) {
                            let inputTrTag = $('<tr>');
                            let imgTrTag = $('<tr>');
                            element1.children.forEach((element2, index2) => {
                                if (index2 == 0) {
                                    // テーブルの体裁を整えるために必要
                                    // ダミー記入行
                                    let inputTdTag = $('<td>');
                                    inputTrTag.append(inputTdTag);

                                    // 試験項目入力
                                    let imgTdTag = $('<td>');
                                    imgTdTag.text(element1.name);
                                    imgTrTag.append(imgTdTag);
                                }

                                // 記入行
                                let inputTag = $('<input>');
                                inputTag.attr('type', 'text');
                                inputTag.attr('value', '');
                                let inputTdTag = $('<td>');
                                inputTdTag.append(inputTag);
                                inputTrTag.append(inputTdTag);

                                // 画像ファイルの繰り返し
                                let imgTag = $('<img>');
                                imgTag.attr('src', element2.img_base64);
                                let imgTdTag = $('<td>');
                                imgTdTag.append(imgTag);
                                imgTrTag.append(imgTdTag);

                            });
                            myTableBody.append(inputTrTag);
                            myTableBody.append(imgTrTag);
                        }
                    });
                }
            });
        }

        // Excelファイル書き込みと保存処理
        async function createAndModifyExcel() {

            // 作業シート
            worksheet = workbook.getWorksheet(1);

            let insertRow = myTableBody.children().length / 2 - 1;
            let insertCol = Math.max(...myTable.find('tr').map((index, elem) => {
                return $(elem).children('td').length;
            }).get()) - 1;
            copyColumnWithStyle(worksheet, 'G', 'H', 1, 6, insertCol);
            copyRowWithStyle(worksheet, insertCol, insertRow);

            // A列の開始行
            let aColStartRow = 6;
            // 入力行
            let inputStartRow = 5;
            // 画像行列
            let imageStartRow = 4;
            let imageStartCol = 1;

            myTableBody.children().each((i, e) => {
                // trの繰り返し
                $(e).children().each(async (j, e1) => {
                    // tdの繰り返し
                    if (i % 2 == 0 && j == 0) {
                        // 何も記入していない行のため処理しない
                        return;
                    }

                    if (j == 0) {
                        // A列の記入内容
                        let cell = worksheet.getCell(`A${aColStartRow}`);
                        cell.value = $(e1).text();
                        aColStartRow += 2;
                        return;
                    }

                    if (i % 2 == 0) {
                        // 記入行
                        let inputTableCell = $(e1);
                        let cell = worksheet.getCell(`${numberToExcelColumn(j + 1)}${inputStartRow}`);
                        cell.value = $(inputTableCell.children()[0]).val();
                        return;
                    }

                    // 画像行
                    let imageTableCell = $(e1);
                    let imageTag = $(imageTableCell.children()[0]);

                    let sheetImg = workbook.addImage({
                        base64: imageTag.attr('src'),
                        extension: 'png'
                    });

                    // let img = await loadImage(imageTag.attr('src'));
                    worksheet.addImage(sheetImg, {
                        tl: { col: Number(imageStartCol + 0.2), row: Number(imageStartRow + 0.5)},
                        // TODO: セルのサイズと画像のサイズをうまく合わせる
                        // アスペクト比がズレるので細かい調節が必要
                        // セル一杯になるようにしたサイズ
                        ext: { width: 245, height: 520},
                        editAs: 'oneCell'
                    });
                    imageStartCol++;
                });
                
                inputStartRow++;
                imageStartRow++;
                imageStartCol = 1;
            });

            const modifiedBuffer = await workbook.xlsx.writeBuffer({
                // base64: true
            });
            // console.log(modifiedBuffer);
            const blob = new Blob([modifiedBuffer.buffer], { type: 'application/octet-stream' });
            saveAs(blob, 'example.xlsx');
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = src;
                console.log("loadImage");
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error("erro load image"));
            });
        }

        // テンプレートエクセル作成確認
        $('#excel-dl').on('click', async (event) => {
            // TODO: 列と行をコピーしてみる
            let worksheet = workbook.worksheets[0];

            let colNum = 50;
            copyColumnWithStyle(worksheet, 'G', 'H', 1, 6, colNum);
            // console.log(excelColumnToNumber("BF"));
            let rowNum = 20;
            copyRowWithStyle(worksheet, colNum, rowNum);

            const excelBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([excelBuffer.buffer], { type: 'application/octet-stream' });
            saveAs(blob, 'template_excel.xlsx');
        });

        function copyColumnWithStyle(worksheet, srcColumnAlpha, startColumnAlpha, startRowNum, endRowNum, destEndColNum) {

            // 追加列数がH列以下なら追加しない
            destEndColNum = destEndColNum - 6;
            if (destEndColNum < 1) {
                return;
            }
            const cols = [...Array(destEndColNum).keys()];
            const rows = [...Array(endRowNum - startRowNum + 1).keys()];

            cols.forEach((index) => {
                // H列に新しい列を挿入
                worksheet.spliceColumns(excelColumnToNumber(startColumnAlpha), 0, []);

                rows.forEach((num, index) => {
                    const srcCell = worksheet.getCell(`${srcColumnAlpha}${num + 1}`);
                    const destCell = worksheet.getCell(`${startColumnAlpha}${num + 1}`);

                    destCell.style = { ...srcCell.style };
                    if (num < 2) {
                        delete destCell.style.border;
                    }
                });
                // 列の幅を設定
                const srcColumn = worksheet.getColumn(excelColumnToNumber(srcColumnAlpha));
                const destColumn = worksheet.getColumn(excelColumnToNumber(startColumnAlpha));
                destColumn.width = srcColumn.width;
            });
        }

        function copyRowWithStyle(worksheet, lastCol, destEndRow, startRow = 5) {

            // 指定した行数分の高さを設定
            const srcInputRow = worksheet.getRow(startRow);
            const srcImageRow = worksheet.getRow(startRow + 1);

            const destStartRow = startRow + 2;
            const rows = [...Array(destEndRow * 2).keys()];
            // 行の高さを設定
            rows.forEach((index) => {
                const height = index % 2 == 0 ? srcInputRow.height : srcImageRow.height;
                const destRow = worksheet.getRow(index + destStartRow);
                destRow.height = height;
            });

            // 8はA〜H列の数
            const cols = [...Array(lastCol + 8).keys()].map(i => i + 1);
            cols.forEach((i) => {
                rows.forEach((j) => {
                    const srcCell = worksheet.getCell(`${numberToExcelColumn(i)}${j % 2 == 0 ? 5 : 6}`);
                    const destCell = worksheet.getCell(`${numberToExcelColumn(i)}${j + 7}`);
                    destCell.style = { ...srcCell.style };
                });
            });
        }

        const ALPHABET_COUNT = 26;

        function excelColumnToNumber(c) {
            return [...c].reduce((n, ch) => {
                return n * ALPHABET_COUNT + ch.charCodeAt(0) - 'A'.charCodeAt(0) + 1;
            }, 0);
        }

        function numberToExcelColumn(n) {
            return n <= 0 ? '' : numberToExcelColumn(Math.floor((n - 1) / ALPHABET_COUNT)) + String.fromCharCode((n - 1) % ALPHABET_COUNT + 'A'.charCodeAt(0));
        }
    </script>
</body>

</html>